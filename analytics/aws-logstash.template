{
	"AWSTemplateFormatVersion": "2010-09-09",

	"Description": "A template to launch elasticsearch cluster.",

	"Metadata" : {
        "DefaultName" : "Logstash"
    },

	"Parameters": {
		"KeyPairName": {
			"Description": "Name of an existing EC2 KeyPair to enable SSH access to the instances",
			"Type": "AWS::EC2::KeyPair::KeyName"
		},

		"LogstashNodeType" : {
			"Description" : "Logstash EC2 instance type. t2.nano should only be used for development purpose.",
			"Type" : "String",
			"Default" : "m3.medium",
			"AllowedValues": [
				"t2.nano",
				"t2.micro",
				"t2.small",
				"m3.medium",
				"m4.large",
				"m4.xlarge",
				"m4.2xlarge",
				"r3.large",
				"r3.xlarge",
				"r3.2xlarge",
				"r3.4xlarge",
				"r3.8xlarge"
			],
			"ConstraintDescription" : "must be a valid EC2 instance type."
		},
		"DebianJsAmiId": {
			"Description": "AMI to use",
			"Default": "ami-fddabdc7",
			"Type": "AWS::EC2::Image::Id"
		},

		"VpcId": {
			"Description" : "VPCid associated with the subnets. [nat-subnets.parameters.VpcId]",
			"Type": "AWS::EC2::VPC::Id"
		},
		"Subnets": {
			"Description" : "Subnet to run HA web cluster on. [nat-subnets.outputs.Subnets]",
			"Type": "List<AWS::EC2::Subnet::Id>"
		},

		"LogStream" : {
			"Description": "Name of VPC traffic log group. [logs-store.resources.LogStream]",
			"Type": "String"
		},

		"VpcTrafficLogGroupName" : {
			"Description": "Name of VPC traffic log group. [logs-store.resources.VpcTrafficLog]",
			"Type": "String"
		},
		"CloudTrailLogGroupName" : {
			"Description": "Name of VPC traffic log group. [logs-store.resources.GlobalCloudTrailLog]",
			"Type": "String"
		},
		"LinuxDockerLogGroupName" : {
			"Description": "Name of VPC traffic log group. [logs-store.resources.LxDockerLog]",
			"Type": "String",
			"Default" : "NO_VALUE"
		},
		"LinuxSysLogGroupName" : {
			"Description": "Name of VPC traffic log group. [logs-store.resources.LxSysLog]",
			"Type": "String",
			"Default" : "NO_VALUE"
		},
		"LinuxAuthLogGroupName" : {
			"Description": "Name of VPC traffic log group. [logs-store.resources.LxAuthLog]",
			"Type": "String",
			"Default" : "NO_VALUE"
		},

		"EsHost" : {
			"Description": "Hostname of Elasticsearch [elasticsearch.outputs.EsElb]",
			"Type": "String",
			"Default": ""
		},

        "RawLogBucketName" : {
			"Description": "Hostname of Elasticsearch [logs-store.resources.Raw]",
			"Type": "String"
		},
        "RawLogSns" : {
			"Description": "Hostname of Elasticsearch [logs-store.resources.RawBucketNotification]",
			"Type": "String"
		},

        "AccessS3LogBucketName" : {
			"Description": "Hostname of Elasticsearch [logs-store.resources.AccessS3Log]",
			"Type": "String"
		},
        "AccessS3LogSns" : {
			"Description": "Hostname of Elasticsearch [logs-store.resources.AccessS3LogBucketNotification]",
			"Type": "String"
		},
        "AccessCfLogBucketName" : {
			"Description": "Hostname of Elasticsearch [logs-store.resources.AccessCfLog]",
			"Type": "String"
		},
        "AccessCfLogSns" : {
			"Description": "Hostname of Elasticsearch [logs-store.resources.AccessCfLogBucketNotification]",
			"Type": "String"
		},

		"LogstashDocker": {
			"Description": "Name of cluster. This is used for discovery.",
			"Type": "String",
			"Default": "bitclouded/ls-aws-kinesis:2.2"
		},
		"LogstashSqsDocker": {
			"Description": "Name of cluster. This is used for discovery.",
			"Type": "String",
			"Default": "bitclouded/ls-aws-sqs3:1.3"
		},
		"CwlUbuntuAgentDocker": {
			"Description": "Name of cluster. This is used for discovery.",
			"Type": "String",
			"Default": "bitclouded/aws-cwl-agent:4.1"
		},
		"CwlLinuxParams" : {
			"Description": "Environment variables for syslog and authlog cwl group names [logs-store.outputs.DockerCwlParams]",
			"Type": "String"
		},
		"CwlDockerParams" : {
			"Description": "Docker log driver params [logs-store.outputs.LxDockerLogParams]",
			"Type": "String"
		},
		"CwlPolicy" : {
			"Description": "Managed policy for linux logging. [logs-store.resources.LinuxLogPolicy]",
			"Type": "String"
		}
	},

	"Mappings" : {
		"InstanceVariables" : {
			"t2.micro": { "ram" : "450" },
			"t2.small": { "ram" : "950" },
			"t2.medium": { "ram" : "1950" },
			"t2.large": { "ram" : "3800" },
			"m3.medium": { "ram" : "1800" },
			"m4.large": { "ram" : "3600" },
			"m4.xlarge": { "ram" : "7000" },
			"m4.2xlarge": { "ram" : "14500" },
			"r3.large": { "ram" : "7500" },
			"r3.xlarge": { "ram" : "15000" },
			"r3.2xlarge": { "ram" : "30000" },
			"r3.4xlarge": { "ram" : "60000" },
			"r3.8xlarge": { "ram" : "120000" }
		}
	},
    
	"Resources" : {
		"LogStreamKclLeasesTable": {
			"Type": "AWS::DynamoDB::Table",
			"Properties": {
				"TableName": { "Ref": "AWS::StackName" },
				"ProvisionedThroughput" : {
					"ReadCapacityUnits" : "10",
					"WriteCapacityUnits" : "10"
				},
				"AttributeDefinitions" : [{
					"AttributeName" : "leaseKey",
					"AttributeType" : "S"   
				}],
				"KeySchema" : [{
					"AttributeName" : "leaseKey",
					"KeyType" : "HASH"
				}]
			}
		},
		
		"LogQueue" : {
			"Type": "AWS::SQS::Queue",
			"Properties": {
				"QueueName": { "Fn::Join": ["", [
					{"Ref": "AWS::StackName"}
				]]},
				"ReceiveMessageWaitTimeSeconds": "20",
				"VisibilityTimeout": 300
			}
		},
		"LogQueuePolicy":{
			"Type":"AWS::SQS::QueuePolicy",
			"Properties":{        
				"PolicyDocument":{
					"Version":"2012-10-17",
					"Id":"LogQueuePolicy",
					"Statement":[
						{
							"Sid":"RawLog",
							"Effect":"Allow",           
							"Principal":"*",
							"Action":["sqs:SendMessage"],
							"Resource":"*",
							"Condition":{
								"ArnEquals":{
									"aws:SourceArn": {"Fn::Join":["", [
										"arn:aws:sns:ap-southeast-2:", {"Ref":"AWS::AccountId"}, ":*"
									]]}
								}
							}
						}
					]
				},
				"Queues":[{"Ref":"LogQueue"}]
			}
		},

		"LogstashSg" : {
			"Type" : "AWS::EC2::SecurityGroup",
			"Properties" : {
				"GroupDescription" : "Security group for logstash nodes.",
				"SecurityGroupEgress" : [
					{ "IpProtocol" : "-1" ,  "CidrIp": "0.0.0.0/0", "FromPort" : "0", "ToPort" : "65535"  }
				],
				"VpcId" : { "Ref" : "VpcId"},
				"Tags": [{"Key": "Name", "Value" : "Ls Nodes"}]
			}
		},

		"LogstashAsg" : {
			"Type" : "AWS::AutoScaling::AutoScalingGroup",
			"Properties" : {
				"VPCZoneIdentifier": { "Ref" : "Subnets" },
				"LaunchConfigurationName" : { "Ref" : "LogstashLc" },
				"MinSize" : "1",
				"MaxSize" : "5",
				"Tags" : [{"Key": "Name", "Value" : "Logstash Kinesis", "PropagateAtLaunch" : "True"}]
			}
		},
		"LogstashLc" : {
			"Type" : "AWS::AutoScaling::LaunchConfiguration",
			"Properties": {
				"InstanceType" : { "Ref" : "LogstashNodeType" },
				"ImageId" : { "Ref" : "DebianJsAmiId" },
				"KeyName" : { "Ref" : "KeyPairName" },
				"SecurityGroups": [
					{ "Ref" : "LogstashSg" }
				],
				"IamInstanceProfile": { "Ref" : "LogstashInstanceProfile" },
				"UserData" : { "Fn::Base64" : { "Fn::Join" : ["", [
                    "#!/bin/bash\n",
					"CWLA=cwlagent-$(curl http://instance-data/latest/meta-data/instance-id)\n",
					"docker run -d --restart=always ",
						"--name $CWLA --log-opt awslogs-stream=$CWLA ",
						"-v /var/log:/var/log-host:ro ",
						{"Ref":"CwlLinuxParams"}," ",
						{"Ref":"CwlDockerParams"}," ",
						{"Ref":"CwlUbuntuAgentDocker"},"\n",

					"docker run -d --name logstash-kinesis --restart=always",
						" -e KINESIS=", {"Ref":"LogStream"},
						" -e DDB_CHECKPOINT=", {"Ref": "AWS::StackName"},
						" -e ES_HOST=", {"Ref":"EsHost"},
						" -e VPC_LOG=", {"Ref":"VpcTrafficLogGroupName"},
						" -e CLOUDTRAIL=", {"Ref":"CloudTrailLogGroupName"},
						" -e DOCKER_LOG=", {"Ref":"LinuxDockerLogGroupName"},
						" -e SYSLOG=", {"Ref":"LinuxSysLogGroupName"},
						" -e AUTHLOG=", {"Ref":"LinuxAuthLogGroupName"},
						" ", {"Ref":"LogstashDocker"}
				]]}},
				"BlockDeviceMappings" : [{
					"DeviceName" : "/dev/xvda",
					"Ebs" : { "VolumeSize" : "50", "VolumeType" : "gp2" }
				}]
			}
		},

		"LogstashInstanceProfile": {
			"Type": "AWS::IAM::InstanceProfile",
			"Properties": {
				"Path": "/analytics/logstash/",
				"Roles": [{ "Ref": "LogstashRole" }]
			}
		},
		"LogstashRole": {
			"Type": "AWS::IAM::Role",
			"Properties": {
				"AssumeRolePolicyDocument": {
					"Version": "2012-10-17",
					"Statement": [
						{
							"Effect": "Allow",
							"Principal": {
								"Service": [ "ec2.amazonaws.com" ]
							},
							"Action": [ "sts:AssumeRole" ]
						}
					]
				},
				"Path": "/analytics/logstash/",
				"ManagedPolicyArns" : [
					{"Ref":"CwlPolicy"}
				]
			}
		},
		"LogstashRolePolicies" : {
			"Type" : "AWS::IAM::Policy",
			"Properties" : {
				"PolicyName" : "LogstashKinesisAccessPolicy",
				"PolicyDocument": {
					"Version" : "2012-10-17",
					"Statement": [
						{
							"Effect": "Allow",
							"Action": "dynamodb:*",
							"Resource": { "Fn::Join": ["", [
								"arn:aws:dynamodb:",{ "Ref": "AWS::Region" },":", {"Ref": "AWS::AccountId"},":table/", { "Ref": "LogStreamKclLeasesTable" }
							]]}
						},
						{
							"Effect": "Allow",
							"Action": [
								"kinesis:Get*",
								"kinesis:List*",
								"kinesis:Describe*"
							],
							"Resource": {"Fn::Join":["",[
								"arn:aws:kinesis:*:",{"Ref":"AWS::AccountId"},":stream/",{"Ref":"LogStream"}
							]]}
						}
					]
				},
				"Roles": [ { "Ref": "LogstashRole" } ]
			}
		},

		"LogstashSqsAsg" : {
			"Type" : "AWS::AutoScaling::AutoScalingGroup",
			"Properties" : {
				"VPCZoneIdentifier": { "Ref" : "Subnets" },
				"LaunchConfigurationName" : { "Ref" : "LogstashSqsLc" },
				"MinSize" : "1",
				"MaxSize" : "20",
				"Tags" : [{"Key": "Name", "Value" : "Logstash Sqs", "PropagateAtLaunch" : "True"}]
			}
		},
		"LogstashSqsLc" : {
			"Type" : "AWS::AutoScaling::LaunchConfiguration",
			"Properties": {
				"InstanceType" : { "Ref" : "LogstashNodeType" },
				"ImageId" : { "Ref" : "DebianJsAmiId" },
				"KeyName" : { "Ref" : "KeyPairName" },
				"SecurityGroups": [
					{ "Ref" : "LogstashSg" }
				],
				"IamInstanceProfile": { "Ref" : "LogstashSqsInstanceProfile" },
				"UserData" : { "Fn::Base64" : { "Fn::Join" : ["", [
                    "#!/bin/bash\n",
					"CWLA=cwlagent-$(curl http://instance-data/latest/meta-data/instance-id)\n",
					"docker run -d --restart=always ",
						"--name $CWLA --log-opt awslogs-stream=$CWLA ",
						"-v /var/log:/var/log-host:ro ",
						{"Ref":"CwlLinuxParams"}," ",
						{"Ref":"CwlDockerParams"}," ",
						{"Ref":"CwlUbuntuAgentDocker"},"\n",
					"docker run -d --restart=always --name cwcron",
						{"Ref":"CwlUbuntuAgentDocker"}," cron\n",

                    "docker run --name logstash-sqs3 -d --restart=always ",
						"-e SQS=", {"Fn::GetAtt":["LogQueue","QueueName"]}, " ",
						"-e ES_HOST=", {"Ref":"EsHost"}, " ",
                        "-e RAW_BUCKET=", {"Ref":"RawLogBucketName"}, " ",
						"-e S3_BUCKET=", {"Ref":"AccessS3LogBucketName"}, " ",
						"-e CF_BUCKET=", {"Ref":"AccessCfLogBucketName"}, " ",
						{"Ref":"LogstashSqsDocker"}
				]]}},
				"BlockDeviceMappings" : [{
					"DeviceName" : "/dev/xvda",
					"Ebs" : { "VolumeSize" : "50", "VolumeType" : "gp2" }
				}]
			}
		},

		"LogstashSqsInstanceProfile": {
			"Type": "AWS::IAM::InstanceProfile",
			"Properties": {
				"Path": "/analytics/logstash/",
				"Roles": [{ "Ref": "LogstashSqsRole" }]
			}
		},
		"LogstashSqsRole": {
			"Type": "AWS::IAM::Role",
			"Properties": {
				"AssumeRolePolicyDocument": {
					"Version": "2012-10-17",
					"Statement": [
						{
							"Effect": "Allow",
							"Principal": {
								"Service": [ "ec2.amazonaws.com" ]
							},
							"Action": [ "sts:AssumeRole" ]
						}
					]
				},
				"Path": "/analytics/logstash/",
				"ManagedPolicyArns" : [
					{"Ref":"CwlPolicy"}
				]
			}
		},
		"LogstashSqsRolePolicies" : {
			"Type" : "AWS::IAM::Policy",
			"Properties" : {
				"PolicyName" : "LogstashSqsPolicy",
				"PolicyDocument": {
					"Version" : "2012-10-17",
					"Statement":[
						{
							"Effect":"Allow",
							"Action":[
								"sqs:*"
							],
							"Resource":[
								{"Fn::GetAtt":["LogQueue","Arn"]}
							] 
						},
						{
							"Effect":"Allow",
							"Action":[
								"s3:Get*"
							],
							"Resource": "*"
						}
					]
				},
				"Roles": [ { "Ref": "LogstashSqsRole" } ]
			}
		}
	},

	"Outputs" : {
	}
}
